<app-header></app-header>
<ion-content>
    <ion-fab vertical="top" horizontal="end" slot="fixed">
        <ion-fab-button [hidden]="!ticket?.ticket_reference_number" id="buttonCall" (click)="sendCall()">
            <ion-icon name="call-outline"></ion-icon>
        </ion-fab-button>
        <a href="https://www.google.com/maps/dir/?api=1&destination={{ticket?.ticket_reference_location}}">
            <ion-fab-button [hidden]="!ticket?.ticket_reference_location" id="buttonNavigate">
                <ion-icon name="navigate-outline"></ion-icon>
            </ion-fab-button>
        </a>
    </ion-fab>
    <ion-grid>
        <ion-row class="ion-margin-horizontal ion-padding-top">
            <ion-col>
                <div class="ticket border-gradient border-gradient-black-bottom titleTicket">
                    <p class="ticketTitle">{{ticket?.title}}</p>
                    <div *ngIf="ticket?.images.length > 0 ">
                        <ion-icon (click)="openImagesSlider(ticket?.images)" name="images-outline"></ion-icon>
                    </div>
                </div>
            </ion-col>
        </ion-row>
        <ion-row class="ion-margin-horizontal">
            <ion-col>
                <div class="ticketDescription ion-margin-horizontal">
                    <p class="description">
                        {{ticket?.description}}
                    </p>
                </div>
                <div class="dataTicket ">
                    <span class="ticketNumber ion-margin-horizontal"># {{ticket?.ticket_number}}</span>
                    <p class="data">
                        {{ticket?.ticket_date}}
                    </p>
                </div>
            </ion-col>
        </ion-row>
        <ion-row class="ion-margin-horizontal  ">
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   statusTitle">
                        <p class="statusTitle">Cliente</p>
                    </div>
                    <div class="ticketStatus">
                        <p class="status">{{ticket?.customer_id?.company_name}}</p>
                    </div>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket    statusTitle">
                        <p class="statusTitle">Inserito Da</p>
                    </div>
                    <div class="ticketStatus">
                        <p class="status">{{ticket?.added_by.username}}</p>
                    </div>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   statusTitle">
                        <p class="statusTitle">Tecnico</p>
                    </div>
                    <div class="ticketStatus">
                        <p class="status">{{ticket?.operator_id?.username}}</p>
                    </div>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">
                    <div class="ticket     statusTitle">
                        <p class="statusTitle">Status</p>
                    </div>
                    <form class="statusValueForm" [formGroup]="statusValue" (ngSubmit)="sendStatusValue()">
                        <div *ngIf="ticketAssigned" class="ticketStatus">
                            <ion-item lines="none">
                                <!-- <ion-label position="stacked" >{{ticket?.status}}</ion-label> -->
                                <ion-select [disabled]="showStatus ||ticket?.customer_id.customer_disabled"
                                    placeholder="{{ticket?.status}}" formControlName="status" interface="action-sheet">
                                    <ion-select-option *ngFor="let status of statusesData?.statuses" value="{{status}}">
                                        {{status}}</ion-select-option>
                                </ion-select>
                                <button (click)="confirmStatustAlert()"
                                    [disabled]="ticket?.customer_id.customer_disabled == true" *ngIf="!showModifyButton"
                                    class="submitStatus" type="submit">OK</button>
                            </ion-item>
                        </div>
                    </form>
                    <div *ngIf="!ticketAssigned" class="requestTicket">
                        <button [disabled]="ticket?.customer_id.customer_disabled" (click)="confirmtakeTicket()">Prendi
                            in carico</button>
                    </div>
                </div>
            </ion-col> 
        </ion-row>
        <ion-item-divider class="blockdivider"></ion-item-divider>

        <ion-row class="ion-margin-horizontal ion-margin-vertical ">
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   statusTitle interventoData">
                        <p class="statusTitle">Nome Referente</p>
                    </div>
                    <div class="ticketStatus">
                        <p>{{ticket?.ticket_reference_name}}</p>
                    </div>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   statusTitle interventoData">
                        <div class="location">
                            <p class="statusTitle">Località referente</p>
                            <ion-button color="dark" class="" (click)="sendReferenceLocation(ticket?._id)">+</ion-button>
                        </div>
                    </div>
                    <ion-item lines="none">

                        <ion-label class="labelOperatività ion-text-center" style="display: contents;">

                            Uscita On Site&nbsp;<input (change)="changeCheck($event.target.value, ticket._id)"
                                type="checkbox" [checked]="sedeCheck">
                            <!-- <ion-checkbox (ionChange)="changeCheck($event.target.value)" [checked]="sedeCheck" color="primary" ></ion-checkbox> -->
                        </ion-label>
                    </ion-item>
                    <ion-item>
                        <ion-input type="text" value="{{ticket?.ticket_reference_location}}"
                        [(ngModel)]="referenceLocation"></ion-input>
                    </ion-item>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   statusTitle interventoData">
                        <p class="statusTitle">Numero Referente</p>
                    </div>
                    <div class="ticketStatus">
                        <p>{{ticket?.ticket_reference_number}}</p>
                    </div>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="3">
                <div class="blockInfo">

                    <div class="ticket   tempistica  statusTitle">
                        <p class="statusTitle">Tipologia Intervento</p>
                    </div>
                    <div>
                        <p class="">{{ticket?.ticket_mode}}</p>
                    </div>
                </div>
            </ion-col>
        </ion-row>
        <ion-item-divider class="blockdivider"></ion-item-divider>

        <ion-row class="ion-margin-horizontal ion-margin-vertical">
            <ion-col size="12">
                <div class="blockInfo ">
                    <p class="statusTitle">Tempistica</p>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="">
                <ion-item class="blockInfo">
                    <ion-label>
                        Inizio:
                    </ion-label>
                    <ion-input displayFormat="DD/MM/YYYY" name="recordHour" [(ngModel)]="recordHour"
                        type="datetime-local"></ion-input>
                </ion-item>
            </ion-col>
            <ion-col size="6" size-sm="">
                <ion-item class="blockInfo">
                    <ion-label>
                        Fine:
                    </ion-label>
                    <ion-input displayFormat="DD/MM/YYYY" name="recordDate" [(ngModel)]="recordDate"
                        type="datetime-local"></ion-input>
                </ion-item>
            </ion-col>
            <ion-col>
                <ion-item lines="none" class="blockInfo">
                    <ion-label><b>In Collaborazione</b></ion-label>
                    <ion-select interface="action-sheet" [(ngModel)]="collabTech" [ngModelOptions]="{standalone:true}"
                        required>
                        <ion-select-option *ngFor="let tech of allTechsToShow" value="{{tech.username}}">
                            {{tech.username}}
                        </ion-select-option>
                    </ion-select>
                </ion-item>
            </ion-col>
            <ion-col size="auto">
                <div class="blockInfo">
                    <ion-button color="dark" class="v-center " (click)="addRecord()">+</ion-button>
                </div>
            </ion-col>

        </ion-row>
        <ion-item-divider class="blockdivider"></ion-item-divider>

        <ion-row *ngFor="let ticketTime of ticket?.ticket_time ; let i = index"
            class="ion-margin-horizontal   ion-margin-vertical">
            <ion-col size="6" size-sm="">
                <div class="blockInfo">
                    <p *ngIf="ticketTime[0]">Inizio: <b>{{ticketTime[0] | date:'dd/MM/yyyy HH:mm' }}</b></p>
                </div>
            </ion-col>
            <ion-col size="6" size-sm="">
                <div class="blockInfo">
                    <p *ngIf="ticketTime[1]">Fine: <b>{{ticketTime[1] | date:'dd/MM/yyyy HH:mm'}}</b></p>
                </div>
            </ion-col>
            <ion-col size="12" size-sm="">
                <div class="blockInfo">
                    <p *ngIf="ticketTime[2]" class="">Collaboratore : <b>{{ticketTime[2]}}</b></p>
                </div>
            </ion-col>
            <ion-col size="12" size-sm="auto">
                <div class="blockInfo">
                    <ion-button size="12" style="width: 100%;" color="danger" (click)="removeTemp(i)"
                        name="close-outline"> <i class="fa fa-minus" aria-hidden="true"></i> </ion-button>
                </div>

            </ion-col>
        </ion-row>
        <ion-item-divider class="blockdivider"></ion-item-divider>

        <ion-row class="ion-margin-horizontal  ion-margin-vertical">
            <ion-col size="12" size-md="">
                <div class="blockInfo">
                    <div class="ticket  statusTitle interventoData">
                        <p class="statusTitle">Note</p>
                        <!-- <ion-icon (click)="ticketNoteModify()" name="checkmark-done-outline"></ion-icon> -->
                        <button (click)="sendNewNote()" class="addButtons">Save</button>
                    </div>
                    <div class="ticketStatus">
                        <!-- <p class="status">{{ticket?.note}}</p> -->
                        <ion-input placeholder="Inserisci Note" [(ngModel)]="modifyNote" type="text"
                            value="{{ticket?.note}}"></ion-input>
                    </div>
                </div>
            </ion-col>
            <ion-col size="12" size-md="">
                <div class="blockInfo">
                    <div class="ticket  statusTitle interventoData">
                        <p class="statusTitle">Delega</p>
                    </div>
                    <!-- </ion-col>
                        <ion-col size-xs=12 size-sm=12 size-md=6 size-lg=6 size-Xl=6> -->
                    <ion-item class="delegaItem" lines="none">
                        <ion-label>Scegli Collega</ion-label>
                        <ion-select (ionChange)="sendDelegaReq()" interface="action-sheet"
                            [(ngModel)]="techReceiveDelega">
                            <ion-select-option *ngFor="let tech of allTechsToShow" value="{{tech?._id}}">
                                {{tech?.username}}
                            </ion-select-option>
                        </ion-select>
                    </ion-item>
                </div>
            </ion-col>
            <ion-col [hidden]="ticket?.reminder.length == 0">
                <div class="blockInfo">
                    <div class="ticket border-gradient border-gradient-black-bottom  statusTitle">
                        <p class="statusTitle">Solleciti</p>
                    </div>
                    <div *ngFor="let remind of  ticket?.reminder" class="ticketStatus ticketBoxRemind">
                        <span class="status">{{remind?.operator}}</span>
                        <span class="status">{{remind?.date | date:' HH:mm dd/MM/yyyy'}}</span>
                    </div>
                </div>
            </ion-col>
        </ion-row>

        <ion-row *ngIf="showSign" class="ion-margin-horizontal ion-padding-vertical">
            <ion-col size="12" class="borderCustom">
                <app-pad-signature (dataUrlSign)="getSign($event)"></app-pad-signature>
                <button (click)="confirmSendSignCustomer()" class="loadSign ion-margin-vertical">Chiudi Ticket</button>
            </ion-col>
        </ion-row>

        <!-- <ion-row class="ion-margin-horizontal ion-margin-bottom">
            <ion-col size="12">
                <img [src]="ticket?.customer_sign" alt="" srcset="">
                <ion-button color="danger" (click)="downloadPDF()" class=" btnSign">Download pdf</ion-button>
            </ion-col>
        </ion-row> -->
        <ion-row *ngIf="!showSign" class="ion-margin-horizontal ion-margin-bottom">
            <ion-col size="12">
                <img [src]="ticket?.customer_sign" alt="" srcset="">
                <button (click)="showSign = true" class=" btnSign">Modifica Firma</button>
            </ion-col>
        </ion-row>

        <ion-row class="ion-margin-horizontal">
            <ion-col>
                <div *ngIf="showModifyButton" class="ticketStatus">
                    <!-- <div class="ticketStatus"> -->
                    <button (click)=" presentModalEditTicket(id)" class="modifyTicketButton modifyButton ">
                        <ion-icon name="create-outline"></ion-icon>Modify
                    </button>
                </div>

            </ion-col>
        </ion-row>
        <ion-row class="ion-margin-horizontal">
            <ion-col>
                <div *ngIf="showModifyButton" class="ticketStatus">
                    <button (click)="presentAlertSollecita()" class="modifyTicketButton modifyButton">
                        <ion-icon name="radio-outline"></ion-icon>Remind
                    </button>
                </div>
            </ion-col>
        </ion-row>
        <ion-row class="ion-margin-horizontal">
            <ion-col>
                <div *ngIf="showModifyButton" class="ticketStatus">
                    <button (click)=" presentAlert()" class="modifyTicketButton delete">
                        <ion-icon name="trash-bin-outline"></ion-icon>Delete
                    </button>
                </div>
            </ion-col>
        </ion-row>
    </ion-grid>
</ion-content>
<ion-footer>
    <app-tabs></app-tabs>
</ion-footer>